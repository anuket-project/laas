{% extends "base.html" %}
{% load static %}
{% load bootstrap4 %}

{% block extrahead %}
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js?lang=yaml"></script>
    <script src="{% static "/js/forms.js" %}"></script>

{% endblock %}
<style>
code {
    overflow: scroll;
}
</style>

{% block content %}
<div class="row">
    <div class="col-12 col-lg-5">
        <div class="card mb-3">
            <div class="card-header d-flex align-items-center">
                <h4>Overview</h4>
            </div>
            <div id="panel_overview">
                <table class="table m-0">
                    <tr>
                        <td>Owner</td>
                        <td>{{ booking.owner }}</td>
                        <td><!-- Owner Action Buttons --></td>
                    </tr>
                    <tr>
                        <td>Collaborators
                        </td>
                        <td>
                            <span id="collab_string">{{ collab_string }}</span>
                        </td>
                        <td>
                          {% if booking.owner == user %}
                          <button class="btn btn-success btn-sm requires-ready" onclick="showAddCollabModal()" disabled="true" title="Inviting additional collaborators is possible after the booking is ready.">Add Collaborators</button>
                        {% endif%}
                        </td>
                    </tr>
                    <tr>
                        <td>Project</td>
                        <td>{{ booking.project }}</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Purpose</td>
                        <td>{{ booking.purpose }}</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Start Time</td>
                        <td>{{ booking.start }}</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>End Time</td>
                        <td id="end_time_text">{{ booking.end }}</td>

                        <td>
                          {% if booking.owner == user %}
                          <button class="btn btn-primary btn-sm requires-ready" onclick="showExtendModal()" title="Inviting additional collaborators is possible after the booking is ready.">Extend Booking</button>
                          {% endif%}
                        </td>

                    </tr>
                    <tr>
                        <td>Lab Deployed At</td>
                        <td>{{ booking.lab }}</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Aggregate ID</td>
                        <td>{{booking.aggregateId}}</td>
                        <td></td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="card mb-3">
          <div class="card-header d-flex">
              <h4>Template Information</h4>
          </div>
          <div>
              <table class="table m-0">
                  {% with status.template as template %}
                  <tr>
                      <th>Name</th>
                      <td>{{ template.name }}</td>
                      <td></td>
                  </tr>
                  <tr>
                      <th>Description</th>
                      <td>{{template.description}}</td>
                      <td></td>
                  </tr>
                  <tr>
                      <th>Owner</th>
                      <td>{{template.owner}}</td>
                      <td></td>
                  </tr>
                  {% endwith %}
                  <table class="table-borderless table-striped table">
                    <tr>
                      <th>Name</th>
                      <th>Image</th>
                      <th>Flavor</th>
                    </tr>
                  {% for host in templatehosts %}
                  <tr>
                      <td style="border:none;">{{host.name}}</th>
                      <td style="border:none;">{{host.image}}</td>
                      <td style="border:none;">{{host.flavor}}</td>
                  </tr>
                  {% endfor %}
                  </table>
              </table>
          </div>
      </div>
    </div>
    <div class="col">
      {% if has_eve_host %}
      <div class="card mb-3 requires-ready" hidden="true">
        <div class="card-header d-flex align-items-center">
          <h4>Using Your EVE-OS Host</h4>
        </div>

        <p class="m-3">
          Please refer to the guide <a href="{{eve_docs_url}}">here</a> for detailed steps on setting up and accessing your resource.
          If there are any problems with your booking, please <a href="mailto:{{contact_email}}">contact us here</a>.
        </p>
      </div>
      {% endif %}

      {% if has_ssh_host %}
        <div class="card mb-3 requires-ready" hidden="true">
          <div class="card-header d-flex align-items-center">
            <h4>Connect to Your Hosts</h4>
          </div>
          <p class="m-3">
            Check the <strong>Deployment Progress</strong> section below for the provisioning status of your hosts. If there are any problems with your booking, please
          <a href="mailto:{{contact_email}}">contact us here</a>.
          </p>
          <div class="mx-3 mb-3 ssh-command" id="sshCommand">
            <div class="d-flex justify-content-between align-items-center" style="background-color: #f3f6f4; padding: 10px; border-radius: 5px;">
                {% for id, inst in status.instances.items %}
                  {% if forloop.first %}
                    <div>
                    ~$ ssh <span id="sshUser">{{ user.userprofile.ipa_username }}</span>@<span id="sshHost">{{ inst.assigned_host_info.hostname }}.{{ host_domain }}</span>
                    </div>
                    {% endif %}
                {% endfor %}
                <div class="btn-group">
                  <button class="btn btn-md btn-outline-secondary" onclick="copySSHCommand()">Copy</button>
                  <button type="button" class="btn btn-md btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-expanded="false">
                    <span>Select Host</span>
                  </button>
                  <div class="dropdown-menu">
                    {% for id, inst in status.instances.items %}
                      <a class="dropdown-item" onclick="updateSSHCommand(this.innerText)" href="#">{{ inst.assigned_host_info.hostname }}</a>
                    {% endfor %}
                  </div>
                </div>
            </div>
          </div>

          <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#instructionModal">
            View Instructions
          </button>
        </div>
        {% endif %}
        <div class="card mb-3">
            <div class="card-header">
                <h4>Deployment</h4>
                <h5 id="progress-header">In Progress - IPMI and connection information will be shown when the booking is ready</h5>
            </div>
            <div id="panel_tasks">
                <table class="table m-0">
                    <tr>
                        <th></th>
                        <th>Name</th>
                        <th>Host</th>
                        <th>Status</th>
                        <th>Host Info</th>
                        <th><!-- log button --></th>
                        <th><!-- ip button --></th>
                    </tr>
                    {% with status.instances as instances %}

                    {% for id, inst in instances.items %}
                    <tr>
                        <td>
                            <!-- icon -->
                            {% if inst.logs|length > 0 %}
                            {% with inst.logs|last as lastelem %}
                            {% if 'Success' in lastelem.status  %}
                            <div id="icon-{{id}}" class="rounded-circle bg-success square-20"></div>
                            {% elif 'Fail' in lastelem.status %}
                            <div id="icon-{{id}}" class="rounded-circle bg-danger square-20"></div>
                            {% else %}
                            <div id="icon-{{id}}" class="spinner-border text-primary square-20"></div>
                            {% endif %}
                            {% endwith %}
                            {% endif %}
                        </td>
                        <td id="alias-{{id}}">
                            <!-- Hostname -->
                            {{inst.host_alias}}
                        </td>
                        <td id="host-{{id}}">
                            <!-- Actual Host -->
                            {{inst.assigned_host_info.hostname}}
                        </td>
                        <td>
                            <!-- Logs -->
                            {% if inst.logs|length > 0 %}
                            {% with inst.logs|last as lastelem %}

                              <p id="status-{{id}}">
                              {{lastelem.status}}
                              </p>

                            {% endwith %}

                            {% endif %}
                          </td>
                          <td>
                            <button class="btn-secondary btn-sm btn ml-3 text-nowrap" data-toggle="modal" onclick="showLogsModal('{{inst.instance}}')">Show Logs</button>
                          </td>
                          <td>
                            <button class="btn-secondary btn-sm btn ml-3 text-nowrap" data-toggle="modal" onclick="showHostInfoModal('{{inst.instance}}')">Host Info</button>
                          </td>
                    </tr>
                    {% endfor %}
                    {% endwith %}
                </table>
            </div>
        </div>
        <div class="card mb-3 requires-ready" hidden="true" id="ipmitool-card">
            <div class="card-header d-flex">
                <h4 class="d-inline">IPMI Tools</h4>
            </div>
            <div class="" id="panel_ipmi">
                <table class="table m-0">
                    <tr>
                        <th>Power</th>
                        <th>Host</th>
                        <th>Controls</th>
                    </tr>
                    {% with status.instances as instances %}

                    {% for id, inst in instances.items %}
                    {% if inst.logs|length > 0 %}
                    {% with inst.logs|last as lastelem %}
                    {% if 'Success' in lastelem.status  %}
                    <tr id="ipmi-block-{{id}}">
                    {% endif %}
                    {% endwith %}
                    {% endif %}
                        <td>
                            <div id="power-icon-{{id}}" class="spinner-border text-primary square-20"></div>
                        </td>
                        <td id="ipmi-host-{{id}}">
                            <!-- Actual Host -->
                            {{inst.assigned_host_info.hostname}}
                        </td>
                        <td>

                        <table>
                            <tr>
                                <td class="border-top-0">
                                    <button id="poweron-{{id}}" class="btn-secondary btn-sm btn ml-3 text-nowrap" onclick="ipmiCommand('PowerOn', '{{id}}')">Power On</button>
                                </td>
                                <td class="border-top-0">
                                    <button id="poweroff-{{id}}" class="btn-secondary btn-sm btn ml-3 text-nowrap" onclick="ipmiCommand('PowerOff', '{{id}}')">Power Off</button>
                                </td>
                                <td class="border-top-0">
                                    <button id="powerreboot-{{id}}" class="btn-secondary btn-sm btn ml-3 text-nowrap" onclick="ipmiCommand('Restart', '{{id}}')">Reboot</button>
                                </td>
                                <td class="border-top-0">
                                    <button type="button" class="btn-secondary btn-sm btn ml-3 text-nowrap" data-toggle="modal" onclick="showRedeployModal('{{id}}')">Redeploy Host</button>
                                </td>
                            </tr>
                        </table>
                    </td>

                    </tr>
                    {% endfor %}
                    {% endwith %}
                </table>
            </div>
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#ipmiModal">Show IPMI Instructions</button>
        </div>
        
    </div>
</div>

<div class="modal fade" id="instructionModal" tabindex="-1" role="dialog" aria-labelledby="instructionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="instructionModalLabel">Connection Instructions</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info" role="alert">
          <strong>Welcome to your resource dashboard!</strong> Please follow the steps below to connect to your allocated resources.
        </div>
        
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Step 1: Download the VPN Client</h5>
            <p class="card-text">
              Begin by downloading the <a href="https://openvpn.net/vpn-client/" target="_blank">OpenVPN Client</a>. This is required to connect to our VPN.
            </p>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Step 2: Set Up Your VPN Connection</h5>
            <p class="card-text">
              Locate the <strong>os-vpn-client.ovpn</strong> file sent to your email upon account creation. Use this file and your account username and password to connect to our VPN.
            </p>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Step 3: Connect to Your Hosts</h5>
            <p class="card-text">
              Once connected, you can access your provisioned hosts over SSH. Each host is accessible at <strong>&lt;host&gt;.{{ host_domain }}</strong>, where <strong>&lt;host&gt;</strong> is your assigned host name.
            </p>
            <div class="alert" style="background-color: #f3f6f4;" role="alert">
              For example, for the host <strong>hpe0</strong>, you would run <strong>ssh &lt;your_username&gt;@hpe0.{{ host_domain }}</strong>.
            </div>
            <p class="card-text">
              Optionally, you can also use the <strong>Copy</strong> and <strong>Select Host</strong> buttons located on this page to copy the complete SSH command to your clipboard for your desired host.
          </div>
        </div>

        <div class="alert alert-warning">
          <strong>Need Help?</strong> If you encounter any issues or require assistance, please <a style="color: inherit; text-decoration: underline;" href="mailto:{{contact_email}}">contact us here</a>.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="HostInfoModal" tabindex="-1" role="dialog" aria-labelledby="HostInfoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="hostInfoModalLabel">Host Info</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="host-info-modal-body">
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="logsModal" tabindex="-1" role="dialog" aria-labelledby="logsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logsModalLabel">Provision Logs</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="padding: 0px;">
                <table class="table table-striped">
                  <tbody  id="log-table">
                    <tr id="log-th">
                      <th>Time</th>
                      <th>Message</th>
                    </tr>
                  </tbody>
                </table>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="ipmiModal" tabindex="-1" role="dialog" aria-labelledby="ipmiModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="ipmiModalLabel">IPMItool Instructions</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info" role="alert">
          If you are on Linux, search and install "ipmitool" via your system's package manager. If you are on Windows, install <a href="https://www.dell.com/support/home/en-us/drivers/driversdetails?driverid=96ph4">Dell's BMC Utility</a> and use ipmitool from there.
        </div>
        
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">Command format</h5>
            <pre><code class="card-text">
              ipmitool -I lanplus -C 3 -H &lt;host's FQDN&gt; -U '{{ status.config.ipmi_username }}' -P '{{ status.config.ipmi_password }}' -L OPERATOR &lt;command&gt;
            </code></pre>
            <table class="table">
              <thead>
                <tr>
                  <th scope="col">Command</th>
                  <th scope="col">Function</th>
                </tr>
              </thead>
              <tr>
                <td><strong>chassis power on</strong></td>
                <td>Powers on the server.</td>
              </tr>
              <tr>
                <td><strong>chassis power off</strong></td>
                <td>Powers off the server.</td>
              </tr>
              <tr>
                <td><strong>chassis status</strong></td>
                <td>Checks the server status.</td>
              </tr>
              <tr>
                <td><strong>chassis power cycle</strong></td>
                <td>Power cycle the server.</td>
              </tr>
              <tr>
                <td><strong>sol activate</strong></td>
                <td>Activates SOL system console.</td>
              </tr>
              <tr>
                <td><strong>sol deactivate</strong></td>
                <td>Deactivates SOL system console.</td>
              </tr>
              <tr>
                <td><strong>sel list</strong></td>
                <td>Returns an error log.</td>
              </tr>
              <tr>
                <td><strong>sdr list</strong></td>
                <td>Lists status of all sensors.</td>
              </tr>
              <tr>
                <td><strong>sol set retry-interval &lt;value&gt;</strong></td>
                <td>Sets the default retry-interval value in milliseconds.</td>
              </tr>
              <tr>
                <td><strong>fpu print</strong></td>
                <td>Prints the FRU information.</td>
              </tr>
              <tr>
                <td><strong>user list</strong></td>
                <td>Lists the IPMI users.</td>
              </tr>
            </table>
            <p class="card-text">Any other commands should work so long as the rest of the text remains.</p>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-body">
            <table class="table m-0">
              <tr>
                  <td class="border-top-0">IPMI Username</td>
                  <td class="border-top-0"><code id="ipmi-username">{{ status.config.ipmi_username }}</code></td>
              </tr>
              <tr>
                  <td>IPMI Password</td>
                  <td><code id="ipmi-password">{{ status.config.ipmi_password }}</code></td>
              </tr>
            </table>
          </div>
        </div>

        {% if ipmi_fqdns.items|length != 0 %}
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title">IPMI FQDNs for your hosts</h5>
            <table class="table">
              <thead>
                <tr>
                  <th scope="col">Host</th>
                  <th scope="col">IPMI FQDN</th>
                </tr>
              </thead>
              {% for hostname, ipmi_fqdn in ipmi_fqdns.items %}
              <tr>
                <td>{{ hostname }}</td>
                <td>{{ ipmi_fqdn }}</td>
              </tr>
              {% endfor %}
            </table>
          </div>
        </div>
        {% endif %}

        <div class="alert alert-warning">
          <strong>Need Help?</strong> If you encounter any issues or require assistance, please <a style="color: inherit; text-decoration: underline;" href="mailto:{{contact_email}}">contact us here</a>.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{% if booking.owner == user %}
<div class="modal fade" id="addCollabModal" tabindex="-1" role="dialog" aria-labelledby="addCollabModal" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Collaborators</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="alert alert-info" role="alert">
          Invite additional users to collaborate on this booking.
          New collaborators will be given VPN access and permission to view this page.
        </div>
        <div class="alert alert-warning" role="alert">
          Please note:
          <ol>
            <li>
              Only users that have marked their profile as "public" will appear in this list.
            </li>
            <li>
              SSH keys and users for the invited collaborators will <strong>NOT</strong> be added to the booked resources.
            </li>
            <li>Collaborators cannot be removed without contacting support.</li>
          </ol>
        </div>
        <div>
          {% bootstrap_field form.users label="Collaborators" %}
        </div>

        <button class="btn btn-success float-right" onclick="submitAddCollabs()">Submit</button>
    </div>
  </div>
</div>
</div>

<div class="modal fade" id="extendModal" tabindex="-1" role="dialog" aria-labelledby="extendModal" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Extend Booking</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="alert alert-info" role="alert">
          You have <span id="span_days">{{booking.ext_days}}</span> extension days remaining. Additional extensions beyond this limit will require approval from the LaaS team.
        </div>
        <div class="d-flex justify-content-center">
          <input id="days_slider_input" type="range" min="1" max="{{booking.ext_days}}" value="1" class="form-control form-control-lg col-xl-5 col-9 p-0" placeholder="Length" oninput="onDaysSliderChange()">
        </div>
        <div class="text-center">
          <span class="col-md-1 col-2 p-0">Days to Extend: <span id="days_number">1</span></span>
        </div>
        <div class="text-center">
          <span class="col-md-1 col-2 p-0">New End Date: <span id="new_end_date">--</span></span>
        </div>
        <div class="text-center">
          <span id="extend_error_text" class="text-danger"></span>
        </div>
        <button class="btn btn-success float-right" onclick="submitExtendBooking()">Submit</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="extendDoneModal" tabindex="-1" role="dialog" aria-labelledby="extendModal" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Extension Processed</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <div class="text-center">
          <span class="col-md-1 col-2 p-0" id="extendDoneModalText">Your booking has been extended.</span>
        </div>
        <button class="btn btn-success float-right" data-dismiss="modal">Continue</button>
      </div>
    </div>
  </div>
</div>



<!-- Extension Form -->
<div class="modal fade" id="extendForm" tabindex="-1" role="dialog" aria-labelledby="extendForm" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Request Booking Extension</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body" id="request-form-modal-body">

        <div class="alert alert-info" role="alert">
          Additional extensions for this booking will require administrator approval. Please enter the details for your extension request, so administrators may review it.
        </div>
        <form class="form-group">
          <label for="extend-request-date-input">Requested End Date</label>
          <input class="form-control" type="date" id="extend-request-date-input"/>
          <br>
          <label for="extend-request-text-input">Reason for Extension</label>
          <textarea class="form-control" id="extend-request-text-input"></textarea>
        </form>
        <p class="text-danger" id="extend-form-error"></p>
        <button class="btn btn-success float-right" onclick="submitExtendForm()">Submit</button>
      </div>
    </div>
  </div>
</div>

{% endif %}

{% for id, inst in status.instances.items %}
<div class="modal fade" id="redeployModal-{{ id }}" tabindex="-1" role="dialog" aria-labelledby="redeployModal-{{ id }}" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Redeploy Host {{ inst.assigned_host }}</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p class="text-danger" id="proctor-message-{{ id }}"></p>
        <p class="text-success" id="success-message-{{ id }}"></p>
        <p class="text-danger" id="failure-message-{{ id }}"></p>
        <div class="dropdown">
          <button class="btn btn-secondary dropdown-toggle" type="button" id="image-selector-{{ id }}" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Select Image
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            {% for im in inst.image_list %}
            <a class="dropdown-item" onclick="selectImageForInstance('{{ id }}', '{{ im.image_id }}', '{{ im.name }}')">{{ im.name }}</a>
            {% endfor %}
          </div>
        </div>
          <button class="btn btn-success float-right" id="submit-button-{{ id }}" onclick="submitRedeploy('{{ id }}')">Submit</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endfor %}

<script>

    let $endTimeCache = +"{{end_formatted}}";
    const agg_id = "{{booking.aggregateId}}"
    const host_count = "{{templatehosts|length}}"
    // if status for a host is success or fail (not spinning), add it to map with true or false.
    const progress_map = new Map();

    // Store latest fetch of logs for use in modal
    const logs_cache = new Map(); // map instance id to logs
    const ext_days_remaining = [Number("{{booking.ext_days}}")]

    const selected_image = new Map(); // Map assigning selected image to each instance based on dropdown

    // Store latest fetch of logs for use in modal
    const instance_cache = new Map(); // map instance id to 

    function updateSSHCommand(selectedHost) {
      const sshHost = selectedHost + '.{{ host_domain }}';

      document.getElementById('sshHost').innerText = sshHost;
    }

    function copySSHCommand() {
    const sshUser = document.getElementById("sshUser").innerText;
    const sshHost = document.getElementById("sshHost").innerText;
    const sshCommand = `ssh ${sshUser}@${sshHost}`;
    
    navigator.clipboard.writeText(sshCommand).catch(err => {
      console.error('Error: ', err);
    });
    }

    async function fetchBookingStatus() {
        data = {"agg_id": agg_id}
        $.ajax({
            url: '',
            type: 'post',
            data: JSON.stringify(data),
            headers: {
                'X-CSRFToken': document.getElementsByName('csrfmiddlewaretoken')[0].value,
                'Content-Type': 'application/json'
            },
            dataType: 'text',
        })
        .done(function(response) {
            updateStatuses(JSON.parse(response))
        })
    }

    async function fetchHostIP(server_name) {
        data = {"server_name": server_name}
        const response = await $.ajax({
            url: '../../resolve/',
            type: 'post',
            data: JSON.stringify(data),
            headers: {
                'X-CSRFToken': document.getElementsByName('csrfmiddlewaretoken')[0].value,
                'Content-Type': 'application/json'
            },
            dataType: 'text',
        })

        return JSON.parse(response);
    }

    async function updateStatuses(status) {
        const instances = status.instances;
        if (!instances) return;

        let instance_iter = Object.keys(instances);
        instance_iter.forEach((instanceId) => {
            const instance = instances[instanceId]
            const status = instance.logs.pop()

            let icon_class = "spinner-border text-primary square-20"
            if (status.status.includes('Success')) {
                icon_class = "rounded-circle bg-success square-20"
                progress_map.set(instance.instance, true)
                document.getElementById("submit-button-" + instanceId).classList.remove("invisible");
            } else if (status.status.includes('Fail')) {
                icon_class = "rounded-circle bg-danger square-20"
                progress_map.set(instance.instance, false)
            }

            logs_cache.set(instance.instance, instance.logs);
            instance_cache.set(instance.instance, instance)
            // icon
            document.getElementById("icon-" + instanceId).className = icon_class;
            // host alias
            document.getElementById("alias-" + instanceId).innerText = instance.host_alias;
            // assigned host
            document.getElementById("host-" + instanceId).innerText = instance.assigned_host_info.hostname;
            // status
            document.getElementById("status-" + instanceId).innerText = status.status;

            if (bookingIsReady()) {
              fetchIpmiStatus(instanceId)
              showAllHidden();
            }
            
        })

        // IPMI
        document.getElementById("ipmi-username").innerText = status.config.ipmi_username;
        document.getElementById("ipmi-password").innerText = status.config.ipmi_password;
    }

    function showAllHidden() {
      let requires_ready = document.getElementsByClassName("requires-ready");
      for (const e of requires_ready) {
        e.removeAttribute("hidden");
        e.removeAttribute("disabled");
      }

      let progress_header = document.getElementById("progress-header");
      progress_header.innerText = "Your booking is ready"
    }

    async function showHostInfoModal(inst_id) {
      $("#HostInfoModal").modal('show');
      
      let modal_body = document.getElementById("host-info-modal-body");
      modal_body.innerHTML = ``;

      if (bookingIsReady()) {
        // host info
        const instance_data = instance_cache.get(inst_id);
        const host_info = instance_data.assigned_host_info;
        const soft_serial = instance_data.soft_serial;
        const host_info_table = document.createElement('table');
        host_info_table.classList.add("table");
        host_info_table.classList.add("table-striped");

        modal_body.appendChild(host_info_table);

        const tr_head = document.createElement('tr');
        tr_head.setAttribute("hidden", "true");

        // name
        const tr_name = document.createElement('tr');
        const td_title_name = document.createElement('td');
        td_title_name.innerText = "Name";
        td_title_name.classList.add("border-top-0");
        const td_name = document.createElement('td')
        td_name.classList.add("border-top-0");
        td_name.innerText = host_info.hostname;
        tr_name.appendChild(td_title_name);
        tr_name.appendChild(td_name);
        host_info_table.appendChild(tr_name);

        // IP
        const address_lists_promise = fetchHostIP(host_info.hostname);

        const tr_ipv4 = document.createElement('tr');
        const td_title_ipv4 = document.createElement('td');
        td_title_ipv4.innerText = "IPv4";
        const td_ipv4 = document.createElement('td');
        td_ipv4.innerText = "Searching . . .";
        tr_ipv4.appendChild(td_title_ipv4);
        tr_ipv4.appendChild(td_ipv4);
        host_info_table.appendChild(tr_ipv4);

        const tr_ipv6 = document.createElement('tr');
        const td_title_ipv6 = document.createElement('td');
        td_title_ipv6.innerText = "IPv6";
        const td_ipv6 = document.createElement('td')
        td_ipv6.innerText = "Searching . . .";
        tr_ipv6.appendChild(td_title_ipv6);
        tr_ipv6.appendChild(td_ipv6);
        host_info_table.appendChild(tr_ipv6);

        // serial
        const tr_serial = document.createElement('tr');
        const td_title_serial = document.createElement('td');
        td_title_serial.innerText = "Serial";
        const td_serial = document.createElement('td');
        if (soft_serial) {
          td_serial.innerText = soft_serial.replaceAll('"', '');
        } else {
          td_serial.innerText = host_info.serial;
        }
        tr_serial.appendChild(td_title_serial);
        tr_serial.appendChild(td_serial);
        host_info_table.appendChild(tr_serial);

        // brand
        const tr_brand = document.createElement('tr');
        const td_title_brand = document.createElement('td');
        td_title_brand.innerText = "Brand";
        const td_brand = document.createElement('td');
        td_brand.innerText = host_info.brand;
        tr_brand.appendChild(td_title_brand);
        tr_brand.appendChild(td_brand);
        host_info_table.appendChild(tr_brand);

        // model
        const tr_model = document.createElement('tr');
        const td_title_model = document.createElement('td');
        td_title_model.innerText = "Model";
        const td_model = document.createElement('td');
        td_model.innerText = host_info.model;
        tr_model.appendChild(td_title_model);
        tr_model.appendChild(td_model);
        host_info_table.appendChild(tr_model);

        const address_lists = await address_lists_promise;
        td_ipv4.innerText = address_lists.v4;
        td_ipv6.innerText = address_lists.v6;

      } else {
        let p_element = document.createElement('p');
        p_element.innerText = "The booking is not ready yet. Please wait until all hosts have finished provisioning.";
        modal_body.appendChild(p_element);
      }
    }

    function showAddCollabModal() {
      $("#addCollabModal").modal('show');
    }

    function showRedeployModal(id) {
      $("#redeployModal-" + id).modal('show');
    }

    function showExtendModal() {
      if (ext_days_remaining > 0) {
        $("#extendModal").modal('show');

        document.getElementById("new_end_date").textContent = new Date($endTimeCache + 86400000).toLocaleDateString(void 0, {
          year: "numeric",
          month: "short",
          day: "numeric",
        });
      } else {
        $("#extendForm").modal('show');
        const date_input = document.getElementById("extend-request-date-input");
        const min = new Date($endTimeCache);
        date_input.setAttribute("min", `${min.getFullYear()}-${(min.getMonth() + 1).toString().padStart(2, "0")}-${(min.getDay() + 1).toString().padStart(2, "0")}`);
      }
    }

    function onDaysSliderChange() {
      let value = document.getElementById("days_slider_input").value;
      document.getElementById("days_number").innerText = value;

      // work.
      document.getElementById("new_end_date").innerText = new Date($endTimeCache + 86400000 * +value).toLocaleDateString(void 0, {
        year: "numeric",
        month: "short",
        day: "numeric",
      });
    }

    async function submitAddCollabs() {
      let collab_ids = collectCollabs();
        $.ajax({
            url: '../../collaborators/{{booking.id}}/',
            type: 'post',
            data: collab_ids,
            headers: {
                'X-CSRFToken': document.getElementsByName('csrfmiddlewaretoken')[0].value,
                'Content-Type': 'application/json'
            },
            dataType: 'text',
        })
        .done(function(response) {
            let collabs = JSON.parse(response);
            document.getElementById("collab_string").innerText = collabs.collaborators;
        })
        .fail(function(response, textStatus, errorThrown) {
            console.log(response, textStatus, errorThrown)
            alert("Unable to add collaborators at this time. If this issue persists, please contact support.")
        })

        $("#addCollabModal").modal('hide');

    }

    async function submitExtendBooking() {
      const slider = document.getElementById("days_slider_input");
      const end_time_text = document.getElementById("end_time_text");
      const span_days = document.getElementById("span_days");
      const error_text = document.getElementById("extend_error_text");
      const days_number = document.getElementById("days_number");
      $.ajax({
            url: '../../extend/{{booking.id}}/',
            type: 'post',
            data: JSON.stringify({
              "days": Number(slider.value)
            }),
            headers: {
                'X-CSRFToken': document.getElementsByName('csrfmiddlewaretoken')[0].value,
                'Content-Type': 'application/json'
            },
            dataType: 'text',
        })
        .done(function(response) {
          $endTimeCache += 86400000 * +slider.value;
          let response_data = JSON.parse(response)
          // update end time on page
          end_time_text.innerText = response_data.updated_end_time;
          // update extension days remaining on page
          ext_days_remaining[0] = response_data.extensions_remaining;
          slider.setAttribute("max", ext_days_remaining[0]);
          span_days.innerText = ext_days_remaining[0];
          days_number.innerText = 1;
          // reset slider values
          slider.value = 1;

          $("#extendModal").modal('hide');
          $("#extendDoneModal").modal("show");
        })
        .fail(function(response, textStatus, errorThrown) {
          error_text.innerText = "There was an error. Please try again later."
        })
    }

    async function submitExtendForm() {
      const modal_body = document.getElementById("request-form-modal-body");
      const date_input = document.getElementById("extend-request-date-input");
      const reason_input = document.getElementById("extend-request-text-input");
      const error_text = document.getElementById("extend-form-error");
      if (!date_input.value || !reason_input.value) {
        error_text.innerText = "Please fill out all fields."
        return;
      }

        $.ajax({
            url: '../../request-extend/{{booking.id}}/',
            type: 'post',
            data: JSON.stringify({
              "date": date_input.value,
              "reason": reason_input.value
            }),
            headers: {
                'X-CSRFToken': document.getElementsByName('csrfmiddlewaretoken')[0].value,
                'Content-Type': 'application/json'
            },
            dataType: 'text',
        })
        .done(function(response) {
          modal_body.innerHTML = "";
          const success_text = document.createElement("div");
          success_text.classList.add("alert-success", "alert");
          success_text.innerText = "Your extension request was received. You will receive an email shortly with the result of your request.";
          modal_body.appendChild(success_text);
        })
        .fail(function(response, textStatus, errorThrown) {
          error_text.innerText = "There was an error. Please try again later."
        })
    }

    async function showLogsModal(instance_id) {
      $("#logsModal").modal('show');

      let log_table = document.getElementById('log-table');
      let log_th = document.getElementById('log-th');

      log_table.innerHTML = ``
      log_table.appendChild(log_th);

      for (const log of logs_cache.get(instance_id)) {
        let log_tr = document.createElement('tr');
        let log_time_td = document.createElement('td');
        let log_message_td = document.createElement('td');

        log_message_td.innerText = log.status;
        log_time_td.innerText = log.time;

        log_tr.appendChild(log_time_td);
        log_tr.appendChild(log_message_td);
        log_table.appendChild(log_tr);
      }
    }

    async function fetchIpmiStatus(hostid) {
        let request = new XMLHttpRequest()
        let url = '../../../liblaas/ipmi/get/' + hostid
        request.onreadystatechange = function() {
            if (request.readyState == 4) {
                switch(request.status) {
                case 200:
                    power = JSON.parse(request.responseText).power_state;
                    updatePowerIcon(hostid, power);
                    break;
                case 400:
                    console.log("bad request");
                    break;
                case 500:
                    console.log("internal server error");
                    break;
                default:
                    console.log("unknown error with response code " + request.status);
                    break;
                }
            }
        };

        request.open("GET", url, true);
        request.setRequestHeader('X-CSRFToken', document.getElementsByName('csrfmiddlewaretoken')[0].value);
        request.send(null);
    }

    async function ipmiCommand(command, hostid) {
        let request = new XMLHttpRequest()
        let url = '../../../liblaas/ipmi/set/' + hostid
        request.open("POST", url, true)
        request.setRequestHeader("Content-Type", "application/json")
        request.setRequestHeader('X-CSRFToken', document.getElementsByName('csrfmiddlewaretoken')[0].value)
        let data = {
          command: command,
          timeout_config: {
            max_retries: 5,
            retry_interval: 10,
            timeout_duration: 60
          }
        }
        request.send(JSON.stringify(data))
    }

    async function submitRedeploy(instance_id , image) {
        if (selected_image[instance_id] == undefined) {
            document.getElementById("proctor-message-" + instance_id).innerHTML = 'Please select an image.'
        } else {
            let request = new XMLHttpRequest()
            let url = '../../../liblaas/reimage/' + instance_id
            request.onreadystatechange = function() {
                if (request.readyState == 4) {
                    switch(request.status) {
                    case 200:
                        document.getElementById("success-message-" + instance_id).innerHTML = "Host is now redeploying.";
                        document.getElementById("proctor-message-" + instance_id).innerHTML = "";
                        document.getElementById("failure-message-" + instance_id).innerHTML = "";
                        document.getElementById("submit-button-" + instance_id).classList.add("invisible");
                        break;
                    case 500:
                        document.getElementById("success-message-" + instance_id).innerHTML = "";
                        document.getElementById("proctor-message-" + instance_id).innerHTML = "";
                        document.getElementById("failure-message-" + instance_id).innerHTML = "There was an error. If this persists, please contact the admins.";
                        break;
                    default:
                        console.log("unknown error with response code " + request.status);
                        break;
                    }
                }
            };
            request.open("POST", url, true)
            request.setRequestHeader("Content-Type", "application/json")
            request.setRequestHeader('X-CSRFToken', document.getElementsByName('csrfmiddlewaretoken')[0].value);
            let data = {
              image_id: selected_image[instance_id],
            };
            request.send(JSON.stringify(data));
        }
    }

    async function successfulRedeploy(instance_id) {
      if (selected_image[instance_id] == undefined) {
          document.getElementById("proctor-message-" + instance_id).innerHTML = 'Please select an image.'
      } else {
          document.getElementById("success-message-" + instance_id).innerHTML = "Host is now redeploying.";
          document.getElementById("proctor-message-" + instance_id).innerHTML = "";
          document.getElementById("submit-button-" + instance_id).classList.add("invisible");
          let request = new XMLHttpRequest()
          let url = '../../../liblaas/reimage/' + instance_id
          request.open("POST", url, true)
          request.setRequestHeader("Content-Type", "application/json")
          request.setRequestHeader('X-CSRFToken', document.getElementsByName('csrfmiddlewaretoken')[0].value);
          let data = {
            image_id: selected_image[instance_id],
          };
          request.send(JSON.stringify(data));
      }
    }

    async function updatePowerIcon(hostid, power_state) {
        let ipmi_icon_class = "spinner-border text-primary square-20"
        if (power_state === "On") {
            ipmi_icon_class = "rounded-circle bg-success square-20"
        } else if (power_state === "Off") {
            ipmi_icon_class = "rounded-circle bg-danger square-20"
        }

        document.getElementById("power-icon-" + hostid).className = ipmi_icon_class;
    }

    function bookingIsReady() {
        return progress_map.size == host_count
    }

    function collectCollabs() {
      // Widget value is initialized to '' but is set to '[]' after adding and removing
  
      let value = document.getElementById('selector').value;
      if (value === '') value = '[]';
      return value;
    }

    function selectImageForInstance(instance_id, image_id, image_name) {
        document.querySelector("#image-selector-" + instance_id).innerHTML = image_name;        
        selected_image[instance_id] = image_id;
    }

    function main() {
      fetchBookingStatus();
      setInterval(function () {
        fetchBookingStatus();
    }, 5000);
    }

    main()
</script>

{% endblock content %}
